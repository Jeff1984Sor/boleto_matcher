{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Financeiro{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid py-4">

    <!-- FILTRO ANO/MES -->
    <form class="d-flex align-items-center gap-2 mb-4 bg-white p-3 rounded shadow-sm">
        <h4 class="fw-bold text-success mb-0 me-auto"><i class="fas fa-chart-pie me-2"></i>Financeiro</h4>
        <select name="mes" class="form-select" style="width: 150px;" onchange="this.form.submit()">
            <option value="1" {% if mes_atual == 1 %}selected{% endif %}>Janeiro</option>
            <!-- ... (repita os meses igual acima) ... -->
            <option value="12" {% if mes_atual == 12 %}selected{% endif %}>Dezembro</option>
        </select>
        <select name="ano" class="form-select" style="width: 100px;" onchange="this.form.submit()">
            <option value="2024" selected>2024</option> <!-- Simplifiquei, use o loop do view -->
            <option value="2025">2025</option>
        </select>
    </form>

    <!-- CARDS TOTAIS -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm border-start border-4 border-success">
                <div class="card-body">
                    <h6 class="text-success fw-bold">Receitas (Pago)</h6>
                    <h3 class="fw-bold">R$ {{ receita_mes|floatformat:2 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm border-start border-4 border-danger">
                <div class="card-body">
                    <h6 class="text-danger fw-bold">Despesas (Pago)</h6>
                    <h3 class="fw-bold">R$ {{ despesa_mes|floatformat:2 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm border-start border-4 {% if resultado_mes < 0 %}border-danger{% else %}border-primary{% endif %}">
                <div class="card-body">
                    <h6 class="text-muted fw-bold">Resultado</h6>
                    <h3 class="fw-bold {% if resultado_mes < 0 %}text-danger{% else %}text-primary{% endif %}">
                        R$ {{ resultado_mes|floatformat:2 }}
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- GRÁFICO ANUAL -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title fw-bold mb-4">Evolução Anual (Receitas x Despesas)</h5>
            <div style="height: 300px;">
                <canvas id="financeChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- CONTRATOS NOVOS -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-info text-white fw-bold">Contratos Novos (Este Mês)</div>
                <div class="list-group list-group-flush">
                    {% for c in contratos_novos %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ c.aluno.nome }}</strong><br>
                                <small>{{ c.plano.nome }}</small>
                            </div>
                            <span class="badge bg-light text-dark">R$ {{ c.valor_total }}</span>
                        </div>
                    {% empty %}
                        <div class="p-3 text-center text-muted">Nenhum contrato novo.</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- CONTRATOS VENCENDO -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-warning text-dark fw-bold">Contratos Vencendo (Este Mês)</div>
                <div class="list-group list-group-flush">
                    {% for c in contratos_vencendo %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ c.aluno.nome }}</strong><br>
                                <small class="text-danger">Vence: {{ c.data_fim|date:"d/m" }}</small>
                            </div>
                            <a href="{% url 'novo_contrato' c.aluno.id %}" class="btn btn-sm btn-outline-primary">Renovar</a>
                        </div>
                    {% empty %}
                        <div class="p-3 text-center text-muted">Nenhum vencimento.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const ctxF = document.getElementById('financeChart').getContext('2d');
    new Chart(ctxF, {
        type: 'line',
        data: {
            labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
            datasets: [
                {
                    label: 'Receitas',
                    data: {{ chart_receita|safe }},
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Despesas',
                    data: {{ chart_despesa|safe }},
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
</script>
{% endblock %}