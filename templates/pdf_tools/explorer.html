<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PDF Tools | Conciliacao</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap');

    :root {
      --bg: #0f141a;
      --bg-2: #111c26;
      --bg-3: #0c1015;
      --card: rgba(18, 26, 34, 0.85);
      --card-2: rgba(18, 26, 34, 0.65);
      --stroke: rgba(255, 255, 255, 0.08);
      --text: #eef2f6;
      --muted: #9aa6b2;
      --accent: #00d1b2;
      --accent-2: #5ee7df;
      --warn: #f2b705;
      --danger: #ff5e5b;
      --ok: #47e37d;
      --glow: 0 0 40px rgba(94, 231, 223, 0.25);
      --shadow: 0 18px 50px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'IBM Plex Sans', system-ui, -apple-system, Segoe UI, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 800px at 15% -10%, #1b2a3a 0%, var(--bg) 45%),
                  radial-gradient(800px 600px at 100% 0%, #1a3a4a 0%, var(--bg-3) 50%),
                  var(--bg);
      min-height: 100vh;
    }

    .noise {
      position: fixed;
      inset: 0;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" opacity="0.05"/></svg>');
      pointer-events: none;
      mix-blend-mode: soft-light;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px 80px;
    }

    header {
      display: grid;
      gap: 16px;
      grid-template-columns: 1fr;
      padding: 28px;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(0, 209, 178, 0.15), rgba(94, 231, 223, 0.06));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
    }

    header h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: clamp(28px, 4vw, 46px);
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.5px;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: 16px;
      max-width: 720px;
    }

    .grid {
      display: grid;
      gap: 20px;
      margin-top: 24px;
      grid-template-columns: repeat(12, 1fr);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(300px 200px at 80% -10%, rgba(94, 231, 223, 0.15), transparent 60%);
      opacity: 0.7;
      pointer-events: none;
    }

    .card h3 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      margin: 0 0 8px;
    }

    .card p {
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 14px;
    }

    .upload {
      border: 1px dashed rgba(94, 231, 223, 0.35);
      background: var(--card-2);
      padding: 16px;
      border-radius: 14px;
      display: grid;
      gap: 10px;
      text-align: center;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .upload.dragover {
      border-color: var(--accent);
      transform: scale(1.01);
      box-shadow: var(--glow);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #021717;
      font-weight: 600;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 8px 24px rgba(0, 209, 178, 0.2);
    }

    .btn.secondary {
      background: transparent;
      border: 1px solid var(--stroke);
      color: var(--text);
      box-shadow: none;
    }

    .btn.small { padding: 6px 10px; font-size: 12px; }
    .btn:hover { transform: translateY(-1px); }

    .list {
      display: grid;
      gap: 10px;
      margin-top: 12px;
      max-height: 260px;
      overflow: auto;
      padding-right: 6px;
    }

    .file {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: rgba(9, 14, 19, 0.5);
      font-size: 13px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .file.processing {
      border-color: var(--accent);
      box-shadow: var(--glow);
      background: rgba(0, 209, 178, 0.08);
    }

    .file.success {
      border-color: var(--ok);
      background: rgba(71, 227, 125, 0.12);
    }

    .file.warning {
      border-color: var(--warn);
      background: rgba(242, 183, 5, 0.1);
    }

    .chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(94, 231, 223, 0.15);
      color: var(--accent-2);
    }

    .summary {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .stat {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(12, 18, 24, 0.6);
      font-size: 13px;
    }

    .logs {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;
      font-size: 12px;
      background: #0b0f14;
      border-radius: 14px;
      padding: 14px;
      border: 1px solid var(--stroke);
      min-height: 180px;
      max-height: 320px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .grid .span-7 { grid-column: span 7; }
    .grid .span-5 { grid-column: span 5; }
    .grid .span-12 { grid-column: span 12; }

    @media (max-width: 980px) {
      .grid .span-7, .grid .span-5 { grid-column: span 12; }
    }
  </style>
</head>
<body>
  <div class="noise"></div>
  <div class="wrap">
    <header>
      <h1>PDF Tools</h1>
      <p>Conciliacao rapida de boletos e comprovantes com extracao estruturada. Envie seus arquivos, rode a combinacao e baixe o ZIP final.</p>
      <div class="summary">
        <div class="stat">Boletos: <strong id="count-boletos">0</strong></div>
        <div class="stat">Comprovantes: <strong id="count-comprovantes">0</strong></div>
        <div class="stat">Status: <strong id="status">Parado</strong></div>
      </div>
    </header>

    <section class="grid">
      <div class="card span-7">
        <h3>Boletos</h3>
        <p>Envie varios PDFs de boletos. Vamos combinar cada boleto com o melhor comprovante.</p>
        <div class="upload" id="drop-boletos">
          <strong>Solte os PDFs aqui</strong>
          <span class="muted">ou</span>
          <input id="input-boletos" type="file" accept="application/pdf" multiple hidden>
          <button class="btn" type="button" data-target="boletos">Selecionar boletos</button>
        </div>
        <div class="list" id="list-boletos"></div>
      </div>

      <div class="card span-5">
        <h3>Comprovantes</h3>
        <p>Envie apenas 1 PDF de comprovantes (com varias paginas). Ele sera dividido por pagina.</p>
        <div class="upload" id="drop-comprovantes">
          <strong>Solte o PDF de comprovantes</strong>
          <span class="muted">ou</span>
          <input id="input-comprovantes" type="file" accept="application/pdf" hidden>
          <button class="btn" type="button" data-target="comprovantes">Selecionar comprovantes</button>
        </div>
        <div class="list" id="list-comprovantes"></div>
      </div>

      <div class="card span-12">
        <h3>Processamento</h3>
        <p>Inicie a conciliacao e acompanhe o progresso em tempo real.</p>
        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
          <button class="btn" id="btn-process">Rodar conciliacao</button>
          <button class="btn secondary" id="btn-refresh">Atualizar lista</button>
          <button class="btn secondary" id="btn-clear">Limpar tudo</button>
          <a class="btn secondary" id="download" href="#" style="display:none;">Baixar ZIP</a>
        </div>
        <div class="logs" id="log"></div>
      </div>
    </section>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const countBoletos = document.getElementById('count-boletos');
    const countComprovantes = document.getElementById('count-comprovantes');
    const downloadEl = document.getElementById('download');
    const fileRows = new Map();

    const api = {
      upload: '/tools/pdf/api/upload/',
      del: '/tools/pdf/api/delete/',
      clear: '/tools/pdf/api/limpar/',
      list: '/tools/pdf/api/listar/',
      process: '/tools/pdf/api/processar/'
    };

    function log(msg) {
      logEl.textContent += msg + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function createFileRow(type, name) {
      const row = document.createElement('div');
      row.className = 'file';
      row.dataset.type = type;
      row.dataset.name = name;
      row.innerHTML = `
        <span>${name}</span>
        <div style="display:flex; gap:8px; align-items:center;">
          <span class="chip">${type}</span>
          <button class="btn secondary small" data-type="${type}" data-name="${name}">Delete</button>
        </div>
      `;
      row.querySelector('button').addEventListener('click', async (e) => {
        await fetch(api.del, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tipo: type, filename: name })
        });
        await refreshList();
      });
      return row;
    }

    function setFileState(name, state) {
      const row = fileRows.get(name);
      if (!row) return;
      row.classList.remove('processing', 'success', 'warning');
      if (state) row.classList.add(state);
    }

    function renderList(type, files) {
      const listEl = document.getElementById(`list-${type}`);
      listEl.innerHTML = '';
      if (!files.length) {
        const empty = document.createElement('div');
        empty.className = 'file';
        empty.textContent = `Nenhum ${type} enviado`;
        listEl.appendChild(empty);
        return;
      }
      if (type === 'boletos') fileRows.clear();
      files.forEach(name => {
        const row = createFileRow(type, name);
        listEl.appendChild(row);
        if (type === 'boletos') fileRows.set(name, row);
      });
    }

    async function refreshList() {
      const res = await fetch(api.list, { cache: 'no-store' });
      const data = await res.json();
      const boletos = data?.arquivos?.boletos || [];
      const comprovantes = data?.arquivos?.comprovantes || [];
      renderList('boletos', boletos);
      renderList('comprovantes', comprovantes);
      countBoletos.textContent = boletos.length;
      countComprovantes.textContent = comprovantes.length;
    }

    async function uploadFiles(type, files) {
      if (!files || !files.length) return;
      setStatus('Enviando...');
      for (const file of files) {
        if (!file.name.toLowerCase().endsWith('.pdf')) {
          log(`Pular: ${file.name} (nao e PDF)`);
          continue;
        }
        const fd = new FormData();
        fd.append('tipo', type);
        fd.append('file', file);
        const res = await fetch(api.upload, { method: 'POST', body: fd });
        const data = await res.json();
        if (data?.error) log(`Erro: ${data.error}`);
        else log(`Enviado: ${data.filename}`);
      }
      await refreshList();
      setStatus('Parado');
    }

    async function runProcess() {
      logEl.textContent = '';
      downloadEl.style.display = 'none';
      setStatus('Processando...');
      const res = await fetch(api.process, { cache: 'no-store' });
      if (!res.ok) {
        let msg = `Erro ${res.status}`;
        try {
          const data = await res.json();
          if (data?.error) msg = `Erro: ${data.error}`;
        } catch (e) {}
        log(msg);
        setStatus('Parado');
        return;
      }
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop();
        for (const line of lines) {
          if (!line.trim()) continue;
          try {
            const evt = JSON.parse(line);
            if (evt.type === 'log') log(evt.data);
            if (evt.type === 'file_start') setFileState(evt.data.filename, 'processing');
            if (evt.type === 'file_done') setFileState(evt.data.filename, evt.data.status);
            if (evt.type === 'finish') {
              log(`Concluido. Total: ${evt.data.total}`);
              downloadEl.href = evt.data.url;
              downloadEl.style.display = 'inline-flex';
            }
          } catch (e) {
            log(`Parse error: ${line}`);
          }
        }
      }
      setStatus('Parado');
      await refreshList();
    }

    function bindDropZone(id, type) {
      const zone = document.getElementById(id);
      const input = document.getElementById(`input-${type}`);
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });
      zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        uploadFiles(type, e.dataTransfer.files);
      });
      document.querySelector(`button[data-target="${type}"]`).addEventListener('click', () => input.click());
      input.addEventListener('change', (e) => uploadFiles(type, e.target.files));
    }

    document.getElementById('btn-refresh').addEventListener('click', refreshList);
    document.getElementById('btn-clear').addEventListener('click', async () => {
      await fetch(api.clear, { method: 'POST' });
      await refreshList();
    });
    document.getElementById('btn-process').addEventListener('click', runProcess);

    bindDropZone('drop-boletos', 'boletos');
    bindDropZone('drop-comprovantes', 'comprovantes');

    refreshList();
  </script>
</body>
</html>
