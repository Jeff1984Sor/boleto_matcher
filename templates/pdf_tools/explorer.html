{% extends 'base.html' %}

{% block title %}Mayacorp Explorer{% endblock %}

{% block content %}
<style>
    /* Estilos mantidos... */
    .drop-zone { border: 2px dashed #ccc; border-radius: 10px; padding: 20px; text-align: center; background: #f9f9f9; cursor: pointer; transition: all 0.3s; }
    .drop-zone:hover, .drop-zone.drag-over { border-color: #007bff; background: #e9ecef; }
    
    .file-list { max-height: 300px; overflow-y: auto; margin-top: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: #fff; transition: all 0.3s; }
    .file-item:last-child { border-bottom: none; }
    
    .status-icon { margin-right: 10px; font-size: 1.2rem; width: 25px; text-align: center; display: inline-block; }
    
    #execution-panel { display: none; margin-top: 20px; }
    #terminal-log {
        background-color: #1a1a1a;
        color: #00ff41;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.85rem;
        padding: 15px;
        border-radius: 5px;
        height: 250px;
        overflow-y: auto;
        border: 1px solid #333;
        box-shadow: inset 0 0 10px #000;
    }
    #terminal-log::-webkit-scrollbar { width: 8px; }
    #terminal-log::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

    .spin-icon { animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    .pulse-btn { animation: pulse 2s infinite; }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    
    /* Toast container */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
</style>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="fas fa-robot"></i> Concilia√ß√£o Inteligente (IA)</h2>
        <button class="btn btn-outline-danger" onclick="limparTudo()">
            <i class="fas fa-trash-alt"></i> Limpar Tudo
        </button>
    </div>
    
    <div class="row">
        <!-- BOLETOS -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span class="fw-bold"><i class="fas fa-file-invoice-dollar"></i> 1. Boletos</span>
                    <span id="count-boletos" class="badge bg-white text-primary rounded-pill">{{ arquivos.boletos|length }}</span>
                </div>
                
                <div class="card-body">
                    <div class="drop-zone" id="drop-boletos" onclick="document.getElementById('input-boletos').click()">
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                        <p class="mb-0 text-muted">Clique ou arraste os PDFs dos boletos</p>
                        <input type="file" id="input-boletos" multiple accept=".pdf" hidden onchange="handleUpload(this.files, 'boletos')">
                    </div>
                    
                    <div class="file-list" id="list-boletos">
                        {% for f in arquivos.boletos %}
                        <div class="file-item" data-filename="{{ f }}">
                            <div><span class="status-icon">üìÑ</span> <span class="filename">{{ f }}</span></div>
                            <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteFile('boletos', '{{ f }}')"><i class="fas fa-times"></i></button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- COMPROVANTES -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <span class="fw-bold"><i class="fas fa-receipt"></i> 2. Comprovantes (1 arquivo)</span>
                    <span id="count-comprovantes" class="badge bg-white text-success rounded-pill">{{ arquivos.comprovantes|length }}</span>
                </div>

                <div class="card-body">
                    <div class="drop-zone" id="drop-comprovantes" onclick="document.getElementById('input-comprovantes').click()">
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                        <p class="mb-0 text-muted">Clique ou arraste o arquivo √∫nico de comprovantes</p>
                        <input type="file" id="input-comprovantes" accept=".pdf" hidden onchange="handleUpload(this.files, 'comprovantes')">
                    </div>
                    
                    <div class="file-list" id="list-comprovantes">
                        {% for f in arquivos.comprovantes %}
                        <div class="file-item" data-filename="{{ f }}">
                            <div><span class="status-icon">üóÇÔ∏è</span> {{ f }}</div>
                            <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteFile('comprovantes', '{{ f }}')"><i class="fas fa-times"></i></button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOT√ÉO DE A√á√ÉO -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <button id="btn-processar" class="btn btn-dark btn-lg px-5 shadow" onclick="startProcessing()" disabled>
                <i class="fas fa-bolt"></i> INICIAR PROCESSAMENTO
            </button>
            <div class="text-muted mt-2" id="btn-help-text">Aguardando arquivos...</div>
        </div>
    </div>

    <!-- PAINEL DE EXECU√á√ÉO -->
    <div id="execution-panel" class="card border-dark shadow-lg mt-4">
        <div class="card-header bg-dark text-white">
            <i class="fas fa-terminal"></i> Log de Execu√ß√£o da IA
        </div>
        <div class="card-body bg-light">
            
            <div class="mb-3">
                <label class="form-label fw-bold text-muted" id="progress-label">Aguardando in√≠cio...</label>
                <div class="progress" style="height: 25px;">
                    <div id="main-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <div id="terminal-log">
                <div>_ Sistema pronto.</div>
            </div>

            <div id="download-area" class="text-center mt-4" style="display: none;">
                <h4 class="text-success fw-bold">‚úÖ Processo Finalizado!</h4>
                <a id="download-link" href="#" class="btn btn-success btn-lg pulse-btn mt-2" download>
                    <i class="fas fa-download"></i> BAIXAR ARQUIVO FINAL (.ZIP)
                </a>
                <p class="text-muted mt-2" id="stats-summary"></p>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<script>
    const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
    const MAX_BUFFER = 1024 * 1024; // 1MB para streaming
    
    // ============================================================
    // UTILIT√ÅRIOS
    // ============================================================
    
    function safeId(filename) {
        return 'file-' + filename.replace(/[^a-zA-Z0-9]/g, '_');
    }
    
    function showToast(message, type = 'info') {
        const types = {
            'success': 'bg-success',
            'error': 'bg-danger',
            'warning': 'bg-warning',
            'info': 'bg-info'
        };
        
        const toastHtml = `
            <div class="toast align-items-center text-white ${types[type]} border-0 mb-2" role="alert" data-bs-autohide="true" data-bs-delay="4000">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        const container = document.getElementById('toast-container');
        container.insertAdjacentHTML('beforeend', toastHtml);
        
        const toastElement = container.lastElementChild;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // Remover do DOM ap√≥s esconder
        toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }
    
    function logToTerminal(msg, color='#00ff41') {
        const term = document.getElementById('terminal-log');
        const time = new Date().toLocaleTimeString();
        
        const div = document.createElement('div');
        div.style.color = color;
        
        const timeSpan = document.createElement('span');
        timeSpan.style.opacity = '0.6';
        timeSpan.textContent = `[${time}] `;
        
        div.appendChild(timeSpan);
        div.appendChild(document.createTextNode(msg));
        
        term.appendChild(div);
        term.scrollTop = term.scrollHeight;
    }
    
    function updateCounter(tipo, delta) {
        const badgeId = (tipo === 'boletos') ? 'count-boletos' : 'count-comprovantes';
        const badge = document.getElementById(badgeId);
        if(badge) {
            let current = parseInt(badge.innerText || "0");
            let novo = current + delta;
            if(novo < 0) novo = 0;
            badge.innerText = novo;
        }
        verificarProntoParaProcessar();
    }
    
    function verificarProntoParaProcessar() {
        const boletos = document.querySelectorAll('#list-boletos .file-item').length;
        const comprovantes = document.querySelectorAll('#list-comprovantes .file-item').length;
        const btn = document.getElementById('btn-processar');
        const helpText = document.getElementById('btn-help-text');
        
        if (boletos > 0 && comprovantes === 1) {
            btn.disabled = false;
            btn.classList.add('pulse-btn');
            helpText.textContent = `Pronto! ${boletos} boletos e 1 arquivo de comprovantes`;
        } else {
            btn.disabled = true;
            btn.classList.remove('pulse-btn');
            
            if (boletos === 0 && comprovantes === 0) {
                helpText.textContent = 'Envie boletos e comprovantes para come√ßar';
            } else if (comprovantes === 0) {
                helpText.textContent = 'Falta o arquivo de comprovantes';
            } else if (boletos === 0) {
                helpText.textContent = 'Envie pelo menos 1 boleto';
            } else if (comprovantes > 1) {
                helpText.textContent = '‚ö†Ô∏è Envie apenas 1 arquivo de comprovantes';
            }
        }
    }
    
    // ============================================================
    // DRAG & DROP
    // ============================================================
    
    function setupDragAndDrop() {
        ['drop-boletos', 'drop-comprovantes'].forEach(id => {
            const zone = document.getElementById(id);
            const tipo = id.split('-')[1];
            
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                zone.classList.add('drag-over');
            });
            
            zone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                zone.classList.remove('drag-over');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                zone.classList.remove('drag-over');
                handleUpload(e.dataTransfer.files, tipo);
            });
        });
    }
    
    // ============================================================
    // UPLOAD
    // ============================================================
    
    async function handleUpload(files, tipo) {
        if (!files || files.length === 0) return;
        
        // Valida√ß√µes espec√≠ficas para comprovantes
        if (tipo === 'comprovantes') {
            const atual = document.querySelectorAll('#list-comprovantes .file-item').length;
            
            if (atual > 0) {
                if (!confirm('J√° existe um arquivo de comprovantes. Substituir?')) {
                    return;
                }
                // Limpar existente
                const items = document.querySelectorAll('#list-comprovantes .file-item');
                for (let item of items) {
                    const filename = item.getAttribute('data-filename');
                    await deleteFile('comprovantes', filename, false);
                }
            }
            
            if (files.length > 1) {
                showToast('‚ö†Ô∏è Apenas 1 arquivo de comprovantes √© permitido', 'warning');
                files = [files[0]];
            }
        }
        
        const listId = `list-${tipo}`;
        const container = document.getElementById(listId);
        
        for (let file of files) {
            // Validar tipo
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showToast(`‚ùå ${file.name}: Apenas PDFs s√£o permitidos`, 'error');
                continue;
            }
            
            // Validar tamanho
            if (file.size > MAX_FILE_SIZE) {
                const sizeMB = (file.size / 1024 / 1024).toFixed(1);
                showToast(`‚ùå ${file.name}: Arquivo muito grande (${sizeMB}MB, m√°x 50MB)`, 'error');
                continue;
            }
            
            const tempId = 'temp-' + Date.now() + '-' + Math.random();
            const div = document.createElement('div');
            div.className = 'file-item';
            div.id = tempId;
            div.innerHTML = `<div><i class="fas fa-spinner fa-spin text-primary"></i> Enviando ${file.name}...</div>`;
            container.appendChild(div);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('tipo', tipo);

            try {
                const res = await fetch("{% url 'api_upload' %}", { 
                    method: 'POST', 
                    body: formData 
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                
                const data = await res.json();
                
                if (data.status === 'ok') {
                    const finalDiv = document.getElementById(tempId);
                    const safeIdValue = safeId(data.filename);
                    
                    finalDiv.id = safeIdValue;
                    finalDiv.setAttribute('data-filename', data.filename);
                    finalDiv.innerHTML = `
                        <div><span class="status-icon">${tipo === 'boletos' ? 'üìÑ' : 'üóÇÔ∏è'}</span> <span class="filename">${data.filename}</span></div>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteFile('${tipo}', '${data.filename.replace(/'/g, "\\'")}')"><i class="fas fa-times"></i></button>
                    `;
                    updateCounter(tipo, 1);
                    showToast(`‚úÖ ${data.filename} enviado`, 'success');
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch(e) {
                console.error('Erro no upload:', e);
                const finalDiv = document.getElementById(tempId);
                if (finalDiv) {
                    finalDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${file.name}: Erro ao enviar</div>`;
                    setTimeout(() => finalDiv.remove(), 5000);
                }
                showToast(`‚ùå Erro ao enviar ${file.name}`, 'error');
            }
        }
    }

    // ============================================================
    // DELETE
    // ============================================================
    
    async function deleteFile(tipo, filename, confirmar = true) {
        if (confirmar && !confirm(`Remover "${filename}"?`)) return;
        
        try {
            const res = await fetch("{% url 'api_delete' %}", {
                method: 'POST',
                body: JSON.stringify({ tipo, filename }),
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!res.ok) throw new Error('Erro na requisi√ß√£o');
            
            const row = document.querySelector(`.file-item[data-filename="${filename}"]`);
            if (row) row.remove();
            
            updateCounter(tipo, -1);
            if (confirmar) showToast(`üóëÔ∏è Arquivo removido`, 'info');
            
        } catch(e) { 
            console.error('Erro ao deletar:', e);
            showToast('‚ùå Erro ao deletar arquivo', 'error');
        }
    }

    async function limparTudo() {
        if (!confirm("Isso apagar√° TODOS os arquivos. Confirmar?")) return;
        
        try {
            const res = await fetch("{% url 'api_limpar' %}", { method: 'POST' });
            if (!res.ok) throw new Error('Erro na requisi√ß√£o');
            
            document.getElementById('list-boletos').innerHTML = '';
            document.getElementById('list-comprovantes').innerHTML = '';
            document.getElementById('count-boletos').innerText = '0';
            document.getElementById('count-comprovantes').innerText = '0';
            
            // Reset UI
            document.getElementById('execution-panel').style.display = 'none';
            verificarProntoParaProcessar();
            
            showToast('üßπ Todos os arquivos foram removidos', 'info');
        } catch(e) { 
            showToast("‚ùå Erro ao limpar arquivos", 'error');
        }
    }

    // ============================================================
    // PROCESSAMENTO
    // ============================================================
    
    let tempoInicio = null;
    
    async function startProcessing() {
        const btn = document.getElementById('btn-processar');
        const panel = document.getElementById('execution-panel');
        const term = document.getElementById('terminal-log');
        const pBar = document.getElementById('main-progress-bar');
        const pLabel = document.getElementById('progress-label');
        
        // Reset
        panel.style.display = 'block';
        panel.scrollIntoView({ behavior: 'smooth' });
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-cog fa-spin"></i> Processando...';
        term.innerHTML = '';
        logToTerminal('üöÄ Conectando ao servidor...');
        pBar.style.width = '5%';
        pBar.classList.remove('bg-success');
        pBar.classList.add('bg-info');
        document.getElementById('download-area').style.display = 'none';
        tempoInicio = Date.now();

        try {
            const response = await fetch("{% url 'api_processar' %}");
            
            if (!response.ok) {
                throw new Error(`Erro ${response.status}: ${response.statusText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                
                // Prote√ß√£o contra buffer overflow
                if (buffer.length > MAX_BUFFER) {
                    console.warn('Buffer muito grande, reiniciando');
                    buffer = buffer.slice(-MAX_BUFFER/2);
                }
                
                const lines = buffer.split('\n');
                buffer = lines.pop();

                for (let line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const event = JSON.parse(line);
                        handleServerEvent(event);
                    } catch(e) { 
                        console.error('Erro ao parsear evento:', e, line);
                    }
                }
            }
        } catch (error) {
            console.error('Erro fatal:', error);
            logToTerminal("‚ùå ERRO: " + error.message, '#ff0000');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-redo"></i> Tentar Novamente';
            showToast('‚ùå Erro no processamento', 'error');
        }
    }

    function handleServerEvent(ev) {
        const pBar = document.getElementById('main-progress-bar');
        const pLabel = document.getElementById('progress-label');

        if (ev.type === 'log') {
            logToTerminal(ev.data);
        }
        else if (ev.type === 'comp_status') {
            pBar.style.width = '30%'; 
            pLabel.innerText = `Lendo Comprovantes: ${ev.data.msg}`;
        }
        else if (ev.type === 'file_start') {
            pLabel.innerText = `üîç Analisando: ${ev.data.filename}`;
            
            const row = document.querySelector(`.file-item[data-filename="${ev.data.filename}"]`);
            if(row) {
                const icon = row.querySelector('.status-icon');
                icon.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i>';
                row.style.backgroundColor = '#f8f9fa';
            }
        }
        else if (ev.type === 'file_done') {
            const row = document.querySelector(`.file-item[data-filename="${ev.data.filename}"]`);
            if(row) {
                const icon = row.querySelector('.status-icon');
                if(ev.data.status === 'success') {
                    icon.innerHTML = '‚úÖ';
                    row.style.backgroundColor = '#d1e7dd';
                } else if (ev.data.status === 'warning') {
                    icon.innerHTML = '‚ö†Ô∏è';
                    row.style.backgroundColor = '#fff3cd';
                } else {
                    icon.innerHTML = '‚ùå';
                    row.style.backgroundColor = '#f8d7da';
                }
            }
            
            // Atualizar progresso
            const total = document.querySelectorAll('#list-boletos .file-item').length;
            const processados = document.querySelectorAll('#list-boletos .file-item [style*="d1e7dd"], #list-boletos .file-item [style*="fff3cd"], #list-boletos .file-item [style*="f8d7da"]').length;
            const percent = Math.round((processados / total) * 70) + 30; // 30% j√° foi usado para comprovantes
            pBar.style.width = percent + '%';
            
            // Estimativa de tempo
            if (tempoInicio) {
                const tempoDecorrido = (Date.now() - tempoInicio) / 1000; // segundos
                const tempoMedio = tempoDecorrido / processados;
                const faltam = total - processados;
                const estimativa = Math.round(faltam * tempoMedio);
                
                if (estimativa > 0 && faltam > 0) {
                    pLabel.innerText = `Processando ${processados}/${total} (~${estimativa}s restantes)`;
                }
            }
        }
        else if (ev.type === 'finish') {
            pBar.style.width = '100%';
            pBar.classList.remove('bg-info');
            pBar.classList.add('bg-success');
            pLabel.innerText = "‚úÖ Processo Conclu√≠do!";
            logToTerminal("üèÅ DOWNLOAD PRONTO!", "#00ff41");
            
            // Estat√≠sticas
            const stats = `${ev.data.matches} encontrados | ${ev.data.sem_match} sem match | Total: ${ev.data.total}`;
            document.getElementById('stats-summary').textContent = stats;
            
            // Mostrar download
            const dlArea = document.getElementById('download-area');
            const dlLink = document.getElementById('download-link');
            dlLink.href = ev.data.url;
            dlArea.style.display = 'block';
            
            // Reabilitar bot√£o
            const btn = document.getElementById('btn-processar');
            btn.innerHTML = '<i class="fas fa-redo"></i> Processar Novamente';
            btn.disabled = false;
            btn.classList.remove('pulse-btn');
            
            showToast('‚úÖ Processamento conclu√≠do!', 'success');
        }
    }
    
    // ============================================================
    // INICIALIZA√á√ÉO
    // ============================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        setupDragAndDrop();
        verificarProntoParaProcessar();
    });
</script>
{% endblock %}