{% extends 'base.html' %}

{% block title %}Mayacorp Explorer{% endblock %}

{% block content %}
<style>
    .drop-zone { border: 2px dashed #ccc; border-radius: 10px; padding: 20px; text-align: center; background: #f9f9f9; cursor: pointer; transition: all 0.3s; }
    .drop-zone:hover { border-color: #007bff; background: #e9ecef; }
    .file-list { max-height: 300px; overflow-y: auto; margin-top: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: #fff; }
    .file-item:last-child { border-bottom: none; }
    .status-icon { margin-right: 10px; font-size: 1.2rem; }
    .status-waiting { color: #ccc; }
    .status-processing { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
</style>

<div class="container-fluid">
    <h2 class="mb-4">üìÇ Gerenciador de Concilia√ß√£o</h2>
    
    <div class="row">
        <!-- LADO ESQUERDO: BOLETOS -->
        <div class="col-md-6">
            <div class="card">
                <!-- ATUALIZADO: Cabe√ßalho com Contador -->
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span>1. Boletos (PDFs Separados)</span>
                    <span id="count-boletos" class="badge bg-white text-primary rounded-pill">{{ arquivos.boletos|length }}</span>
                </div>
                
                <div class="card-body">
                    <div class="drop-zone" id="drop-boletos" onclick="document.getElementById('input-boletos').click()">
                        <p class="mb-0">Arraste os boletos aqui ou clique para selecionar</p>
                        <input type="file" id="input-boletos" multiple accept=".pdf" hidden onchange="handleUpload(this.files, 'boletos')">
                    </div>
                    
                    <div class="file-list" id="list-boletos">
                        <!-- Lista preenchida via JS -->
                        {% for f in arquivos.boletos %}
                        <div class="file-item" id="file-row-{{ f }}">
                            <div><span class="status-icon status-waiting">üìÑ</span> {{ f }}</div>
                            <button class="btn btn-sm btn-danger" onclick="deleteFile('boletos', '{{ f }}')">√ó</button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- LADO DIREITO: COMPROVANTES -->
        <div class="col-md-6">
            <div class="card">
                <!-- ATUALIZADO: Cabe√ßalho com Contador -->
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <span>2. Arquivo de Comprovantes</span>
                    <span id="count-comprovantes" class="badge bg-white text-success rounded-pill">{{ arquivos.comprovantes|length }}</span>
                </div>

                <div class="card-body">
                    <div class="drop-zone" id="drop-comprovantes" onclick="document.getElementById('input-comprovantes').click()">
                        <p class="mb-0">Arraste o arquiv√£o aqui</p>
                        <input type="file" id="input-comprovantes" accept=".pdf" hidden onchange="handleUpload(this.files, 'comprovantes')">
                    </div>
                    
                    <div class="file-list" id="list-comprovantes">
                        {% for f in arquivos.comprovantes %}
                        <div class="file-item" id="file-row-{{ f }}">
                            <div><span class="status-icon status-waiting">üóÇÔ∏è</span> {{ f }}</div>
                            <button class="btn btn-sm btn-danger" onclick="deleteFile('comprovantes', '{{ f }}')">√ó</button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RODAP√â: A√á√ïES -->
    <div class="card mt-4 shadow">
        <div class="card-body d-flex justify-content-between align-items-center">
            
            <!-- Status no canto esquerdo -->
            <div id="status-bar" class="text-muted fw-bold">Aguardando arquivos...</div>
            
            <!-- Bot√µes no canto direito -->
            <div class="d-flex gap-2">
                <!-- NOVO BOT√ÉO LIMPAR -->
                <button class="btn btn-outline-danger btn-lg" onclick="limparTudo()">
                    üóëÔ∏è Limpar Tudo
                </button>

                <button id="btn-processar" class="btn btn-dark btn-lg" onclick="startProcessing()">
                    ‚ö° Iniciar Concilia√ß√£o
                </button>
            </div>

        </div>
    </div>

<script>
    // --- FUN√á√ÉO AUXILIAR: ATUALIZAR CONTADOR ---
    function updateCounter(tipo, delta) {
        const badgeId = (tipo === 'boletos') ? 'count-boletos' : 'count-comprovantes';
        const badge = document.getElementById(badgeId);
        if(badge) {
            let current = parseInt(badge.innerText || "0");
            let novo = current + delta;
            if(novo < 0) novo = 0;
            badge.innerText = novo;
        }
    }

    // --- 1. UPLOAD ---
    async function handleUpload(files, tipo) {
        const listId = `list-${tipo}`;
        const container = document.getElementById(listId);
        
        for (let file of files) {
            // Cria UI tempor√°ria
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `<div><span class="spinner-border spinner-border-sm"></span> ${file.name}</div>`;
            container.appendChild(div);

            // Envia pro servidor
            const formData = new FormData();
            formData.append('file', file);
            formData.append('tipo', tipo);

            try {
                const res = await fetch("{% url 'api_upload' %}", { method: 'POST', body: formData });
                const data = await res.json();
                if(data.status === 'ok') {
                    // Atualiza UI para sucesso
                    div.id = `file-row-${data.filename}`;
                    div.innerHTML = `
                        <div><span class="status-icon status-waiting">üìÑ</span> ${data.filename}</div>
                        <button class="btn btn-sm btn-danger" onclick="deleteFile('${tipo}', '${data.filename}')">√ó</button>
                    `;
                    // ATUALIZA O CONTADOR (+1)
                    updateCounter(tipo, 1);
                }
            } catch(e) {
                div.innerHTML = `<span class="text-danger">Erro ao subir ${file.name}</span>`;
            }
        }
    }

    // --- 2. DELETAR ---
    async function deleteFile(tipo, filename) {
        if(!confirm('Remover arquivo?')) return;
        
        try {
            await fetch("{% url 'api_delete' %}", {
                method: 'POST',
                body: JSON.stringify({ tipo, filename }),
                headers: { 'Content-Type': 'application/json' }
            });
            document.getElementById(`file-row-${filename}`).remove();
            
            // ATUALIZA O CONTADOR (-1)
            updateCounter(tipo, -1);

        } catch(e) { alert('Erro ao deletar'); }
    }

    // --- 3. PROCESSAMENTO (STREAM) ---
    async function startProcessing() {
        const btn = document.getElementById('btn-processar');
        const status = document.getElementById('status-bar');
        
        btn.disabled = true;
        btn.innerText = "Processando...";
        status.innerText = "Iniciando conex√£o com IA...";

        const response = await fetch("{% url 'api_processar' %}");
        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (let line of lines) {
                if (!line.trim()) continue;
                try {
                    const event = JSON.parse(line);
                    handleEvent(event);
                } catch(e) {}
            }
        }
    }

    function handleEvent(ev) {
        const status = document.getElementById('status-bar');
        
        if(ev.type === 'log') {
            status.innerText = ev.data;
        }
        else if(ev.type === 'file_start') {
            // Marca o √≠cone como "girando"
            const row = document.getElementById(`file-row-${ev.data.filename}`);
            if(row) row.querySelector('.status-icon').innerText = '‚è≥';
        }
        else if(ev.type === 'file_done') {
            // Marca check verde ou alerta
            const row = document.getElementById(`file-row-${ev.data.filename}`);
            if(row) {
                const icon = row.querySelector('.status-icon');
                if(ev.data.status === 'success') {
                    icon.innerText = '‚úÖ';
                    row.style.backgroundColor = '#d4edda'; // Verde claro
                } else {
                    icon.innerText = '‚ö†Ô∏è';
                    row.style.backgroundColor = '#fff3cd'; // Amarelo
                }
            }
        }
        else if(ev.type === 'finish') {
            status.innerHTML = `<a href="${ev.data.url}" class="btn btn-success fw-bold">‚¨áÔ∏è DOWNLOAD ZIP COMPLETO</a>`;
            document.getElementById('btn-processar').innerText = "Conclu√≠do";
        }
    }

    async function limparTudo() {
        if (!confirm("Tem certeza que deseja apagar TODOS os arquivos da lista?")) {
            return;
        }

        try {
            // Chama o backend para apagar os arquivos fisicamente
            const res = await fetch("{% url 'api_limpar' %}", { method: 'POST' });
            const data = await res.json();

            if (data.status === 'ok') {
                // Limpa a tela visualmente
                document.getElementById('list-boletos').innerHTML = '';
                document.getElementById('list-comprovantes').innerHTML = '';
                document.getElementById('status-bar').innerText = "Arquivos removidos com sucesso.";
                
                // Reseta cores e √≠cones se tiver sobrado algo
                document.getElementById('btn-processar').disabled = false;
                document.getElementById('btn-processar').innerText = "‚ö° Iniciar Concilia√ß√£o";

                // ZERA OS CONTADORES VISUALMENTE
                document.getElementById('count-boletos').innerText = "0";
                document.getElementById('count-comprovantes').innerText = "0";

            } else {
                alert("Erro ao limpar: " + data.error);
            }
        } catch(e) {
            alert("Erro de conex√£o ao tentar limpar.");
        }
    }
</script>
{% endblock %}