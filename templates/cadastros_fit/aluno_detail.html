{% extends 'base.html' %}
{% load static %}

{% block title %}{{ aluno.nome }} | MayaCorp Fit{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto pb-24 px-4 sm:px-6">

<!-- ================= HEADER DO ALUNO ================= -->
<header class="bg-white rounded-[3rem] shadow-2xl border border-slate-100 p-10 mb-12 relative overflow-hidden">
    <div class="absolute top-0 right-0 w-96 h-96 bg-primary/5 rounded-full -mr-40 -mt-40 blur-3xl"></div>

    <div class="relative z-10 flex flex-col lg:flex-row gap-10 items-center">
        <!-- FOTO -->
        <div class="w-40 h-40 rounded-[3rem] overflow-hidden shadow-xl border-4 border-white bg-slate-100 flex items-center justify-center text-5xl font-black text-primary">
            {% if aluno.foto_rosto %}
                <img src="{{ aluno.foto_rosto.url }}" class="w-full h-full object-cover">
            {% else %}
                {{ aluno.nome|first }}
            {% endif %}
        </div>

        <!-- INFO -->
        <div class="flex-1 text-center lg:text-left">
            <h1 class="text-4xl font-black text-slate-900 uppercase tracking-tight">
                {{ aluno.nome }}
            </h1>
            <p class="text-xs font-black text-slate-400 uppercase tracking-widest mt-1">
                ID #{{ aluno.id }}
            </p>

            <div class="flex flex-wrap justify-center lg:justify-start gap-6 mt-6">
                <div class="flex items-center gap-2 font-bold text-slate-600">
                    <i class="fab fa-whatsapp text-emerald-500"></i>
                    {{ aluno.telefone|default:"—" }}
                </div>
                <div class="flex items-center gap-2 font-bold text-slate-600">
                    <i class="far fa-id-card text-blue-500"></i>
                    {{ aluno.cpf|default:"CPF não informado" }}
                </div>
            </div>

            <!-- AÇÕES -->
            <div class="flex flex-wrap gap-3 mt-8 justify-center lg:justify-start">
                <a href="{% url 'aluno_update' aluno.pk %}"
                   class="btn bg-slate-900 text-white rounded-xl px-6 font-black uppercase text-[10px] tracking-widest">
                    Editar
                </a>

                <button onclick="enviarCobranca({{ aluno.id }})"
                        class="btn bg-emerald-500 text-white rounded-xl px-6 font-black uppercase text-[10px] tracking-widest">
                    Cobrar
                </button>

                <a href="{% url 'novo_contrato' aluno.pk %}"
                   class="btn bg-secondary text-white rounded-xl px-6 font-black uppercase text-[10px] tracking-widest">
                    Nova venda
                </a>
            </div>
        </div>
    </div>
</header>

<!-- ================= KPIs ================= -->
<section class="grid grid-cols-2 md:grid-cols-5 gap-6 mb-12">

    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Status</p>
        <p class="text-xl font-black text-emerald-600">Ativo</p>
    </div>

    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Financeiro</p>
        {% if total_em_aberto > 0 %}
            <p class="text-xl font-black text-red-600">Em aberto</p>
        {% else %}
            <p class="text-xl font-black text-emerald-600">Em dia</p>
        {% endif %}
    </div>

    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Última aula</p>
        <p class="text-xl font-black text-slate-800">{{ ultima_aula|default:"—" }}</p>
    </div>

    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Frequência</p>
        <p class="text-xl font-black text-slate-800">{{ percentual_presenca }}%</p>
    </div>

    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Próx. venc.</p>
        <p class="text-xl font-black text-slate-800">
            {{ proximo_vencimento|date:"d/m"|default:"—" }}
        </p>
    </div>

</section>

<!-- ================= ABAS ================= -->
<div class="bg-white rounded-[3rem] shadow-2xl border border-slate-100 overflow-hidden">

<!-- NAV -->
<div class="flex bg-slate-50 p-2">
    <button class="tab-btn active" onclick="openTab(event,'financeiro')">Financeiro</button>
    <button class="tab-btn" onclick="openTab(event,'prontuario')">Prontuário</button>
    <button class="tab-btn" onclick="openTab(event,'agenda')">Agenda</button>
    <button class="tab-btn" onclick="openTab(event,'contratos')">Contratos</button>
</div>

<div class="p-10">

<!-- ================= FINANCEIRO ================= -->
<div id="financeiro" class="tab-content grid md:grid-cols-2 gap-6">
{% for l in financeiro_completo %}
<div class="bg-white border border-slate-100 rounded-2xl p-6 shadow-sm">
    <div class="flex justify-between items-center mb-3">
        <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">
            {{ l.data_vencimento|date:"d/m/Y" }}
        </span>
        {% if l.status == 'PAGO' %}
            <span class="px-3 py-1 text-[9px] font-black bg-emerald-100 text-emerald-700 rounded-full">PAGO</span>
        {% else %}
            <span class="px-3 py-1 text-[9px] font-black bg-red-100 text-primary rounded-full">PENDENTE</span>
        {% endif %}
    </div>
    <p class="font-black text-slate-900 uppercase">{{ l.descricao }}</p>
    <p class="text-xl font-black text-slate-900 mt-2">R$ {{ l.valor }}</p>
</div>
{% empty %}
<p class="text-slate-400 italic">Nenhum lançamento financeiro.</p>
{% endfor %}
</div>

<!-- ================= PRONTUÁRIO ================= -->
<div id="prontuario" class="tab-content hidden space-y-6">
{% for p in agenda_completa %}
<div class="relative pl-6">
    <div class="absolute left-0 top-2 w-2 h-2 bg-secondary rounded-full"></div>
    <div class="bg-white border border-slate-100 rounded-2xl p-6 shadow-sm">
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">
            {{ p.aula.data_hora_inicio|date:"d/m/Y H:i" }} • {{ p.aula.profissional.nome }}
        </p>
        <p class="text-sm text-slate-700 mt-2">
            {{ p.aula.evolucao_texto|default:"Sem registro clínico." }}
        </p>
    </div>
</div>
{% empty %}
<p class="text-slate-400 italic">Nenhum registro clínico.</p>
{% endfor %}
</div>

<!-- ================= AGENDA ================= -->
<div id="agenda" class="tab-content hidden space-y-4">
{% for p in agenda_completa %}
<div class="flex justify-between items-center bg-white border border-slate-100 rounded-2xl p-6 shadow-sm">
    <div>
        <p class="font-black text-slate-900">{{ p.aula.data_hora_inicio|date:"d/m/Y" }}</p>
        <p class="text-xs text-slate-500 font-bold">
            {{ p.aula.data_hora_inicio|date:"H:i" }} — {{ p.aula.data_hora_fim|date:"H:i" }}
        </p>
    </div>
    <span class="px-4 py-2 text-[10px] font-black uppercase rounded-xl bg-slate-100 text-slate-600">
        {{ p.status }}
    </span>
</div>
{% empty %}
<p class="text-slate-400 italic">Nenhuma aula registrada.</p>
{% endfor %}
</div>

<!-- ================= CONTRATOS ================= -->
<div id="contratos" class="tab-content hidden grid md:grid-cols-2 gap-6">
{% for c in contratos_completo %}
<div class="bg-white border border-slate-100 rounded-3xl p-8 shadow-sm">
    <p class="font-black text-slate-900 uppercase">{{ c.plano.nome }}</p>
    <p class="text-xs text-slate-500 font-bold mt-2">
        {{ c.data_inicio|date:"d/m/Y" }} — {{ c.data_fim|date:"d/m/Y" }}
    </p>
    <p class="text-xl font-black text-slate-900 mt-4">R$ {{ c.valor_total }}</p>
</div>
{% empty %}
<p class="text-slate-400 italic">Nenhum contrato ativo.</p>
{% endfor %}
</div>

</div>
</div>
</div>

<!-- ================= ESTILOS ================= -->
<style>
.tab-btn{
    flex:1;
    padding:16px;
    font-weight:900;
    text-transform:uppercase;
    font-size:11px;
    border-radius:12px;
}
.tab-btn.active{
    background:white;
    color:var(--color-primary);
}
.tab-content{
    animation:fade .25s ease;
}
@keyframes fade{
    from{opacity:0}
    to{opacity:1}
}
</style>

<!-- ================= SCRIPTS ================= -->
<script>
function openTab(e,id){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.remove('hidden');
    e.currentTarget.classList.add('active');
}

function enviarCobranca(id){
    if(confirm('Enviar cobrança automática para este aluno?')){
        fetch(`/comunicacao/enviar-cobranca/${id}/`)
            .then(()=>alert('Cobrança enviada com sucesso'));
    }
}
</script>

{% endblock %}
